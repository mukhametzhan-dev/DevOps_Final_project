name: CI Pipeline for Backend

on:
  # –ó–∞–ø—É—Å–∫ –ø—Ä–∏ PUSH –≤ main
  push:
    branches: [ "main" ] 
  # –ó–∞–ø—É—Å–∫ –ø—Ä–∏ PULL REQUEST –≤ main (–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ)
  pull_request:
    branches: [ "main" ] 
  # –¢–∞–∫–∂–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –≤—Ä—É—á–Ω—É—é –∏–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ GitHub (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞)
  workflow_dispatch:

jobs:
  build_and_test:
    runs-on: ubuntu-latest # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ä–∞–Ω–Ω–µ—Ä GitHub Actions

    steps:
      # 1. Checkout (–ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–¥–∞)
      - name: üîÑ Checkout repository
        uses: actions/checkout@v4

      # 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Python
      - name: üêç Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          # –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤–µ—Ä—Å–∏—é, –∫–æ—Ç–æ—Ä–∞—è —É –≤–∞—Å —Ä–∞–±–æ—Ç–∞–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ
          python-version: '3.10'
          cache: 'pip' 

      # 3. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      - name: üì¶ Install dependencies
        run: |
          python -m pip install --upgrade pip
          # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö –ø–∞–∫–µ—Ç–æ–≤, –≤–∫–ª—é—á–∞—è psycopg2-binary, pytest –∏ —Ç.–¥.
          pip install -r requirements.txt
          
      # 4. –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ (–ö—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è 15 –±–∞–ª–ª–æ–≤ –∑–∞ —Ç–µ—Å—Ç—ã)
      - name: ‚úÖ Run tests (Pytest)
        run: |
          # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ PYTHONPATH –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –∏–º–ø–æ—Ä—Ç–∞ –º–æ–¥—É–ª–µ–π, –∫–∞–∫ –º—ã –¥–µ–ª–∞–ª–∏ –ª–æ–∫–∞–ª—å–Ω–æ
          PYTHONPATH=. pytest
        # –ï—Å–ª–∏ —Ç–µ—Å—Ç—ã –Ω–µ –ø—Ä–æ–π–¥—É—Ç, –ø–∞–π–ø–ª–∞–π–Ω –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è –Ω–µ—É–¥–∞—á–µ–π.

      # 5. –°–±–æ—Ä–∫–∞ Docker-–æ–±—Ä–∞–∑–∞ –±—ç–∫–µ–Ω–¥–∞ (15 –±–∞–ª–ª–æ–≤ –∑–∞ Docker)
      - name: ‚öôÔ∏è Set up QEMU (–¥–ª—è –º—É–ª—å—Ç–∏–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–π —Å–±–æ—Ä–∫–∏)
        uses: docker/setup-qemu-action@v3
      
      - name: üê≥ Set up Docker Buildx (–¥–ª—è —Å–±–æ—Ä–∫–∏)
        uses: docker/setup-buildx-action@v3

      - name: üèóÔ∏è Build Backend Docker image
        uses: docker/build-push-action@v5
        with:
          context: . # –ö–æ–Ω—Ç–µ–∫—Å—Ç —Å–±–æ—Ä–∫–∏ ‚Äî –∫–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞
          file: ./backend/Dockerfile # –ü—É—Ç—å –∫ Dockerfile
          push: false # –ú—ã –Ω–µ –¥–µ–ª–∞–µ–º push –≤ Docker Hub (—ç—Ç–æ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
          tags: ${{ github.repository }}/backend:latest
          # –ù–∞ —ç—Ç–æ–º —à–∞–≥–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Å–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–∞. –ï—Å–ª–∏ Dockerfile –Ω–µ–≤–µ—Ä–Ω—ã–π, –ø–∞–π–ø–ª–∞–π–Ω —É–ø–∞–¥–µ—Ç.